<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%"
	creationComplete="doCreationComplete(event)" title="Data Source Creation">
	<mx:Script>
    <![CDATA[
        import mx.controls.Alert;
        import mx.managers.PopUpManager;
        import com.easyinsight.framework.User;
        import mx.validators.Validator;
        // Reference to the file on disk (selected by user)
        [Bindable]
        public var file:FileReference = new FileReference();

        [Bindable]
        [Embed(source="../../../../assets/excelexample.PNG")]
        private var excelImage:Class;

        private var validators:Array;

        private var uploadID:Number;

        // Called when the "Browse" button is clicked
        public function doBrowse( event:Event ):void
        {
            // Prompt the user to select a file from disk
            file.browse();
        }

        private function next():void {
            var results:Array = Validator.validateAll(validators);
            if (results.length > 0) {
                Alert.show("You must enter a data source name of at least three characters.");
            } else {
                nextButton.enabled = false;
                finishingSection.visible = true;
                uploadService.create.send(uploadID, feedName.text);
            }
            //dispatchEvent(new UserUploadEvent(UserUploadEvent.USER_UPLOAD_COMPLETE, uploadID));
        }

        private function created():void {
            var uploadResponse:UploadResponse = uploadService.create.lastResult as UploadResponse;
            if (uploadResponse.successful) {
                dispatchEvent(new UploadConfigEvent(UploadConfigEvent.UPLOAD_CONFIG_COMPLETE, uploadResponse.feedID, feedName.text));
                PopUpManager.removePopUp(this);
            } else {
                Alert.show(uploadResponse.failureMessage);
            }
        }

        // Called when the upload operation has completed
        // Specifically manages response data
        public function doComplete( event:DataEvent ):void
        {
            var xml:XML = new XML(event.data);
            var uploadIDString:String = xml.uploadID.toString();
            this.uploadID = parseInt(uploadIDString);
            successMessage.visible = true;
            //formatBox.enabled = true;
            nextButton.enabled = true;
        }

        // Called when the application has completed startup
        public function doCreationComplete( event:Event ):void
        {
            validators = [ nameValidator ];
            // Listen for when the user has selected a file
            // Listen for when the file upload is complete
            file.addEventListener( Event.SELECT, doSelect );
            file.addEventListener( DataEvent.UPLOAD_COMPLETE_DATA, doComplete );
            file.addEventListener( IOErrorEvent.IO_ERROR, onIOError);
        }

        private function onIOError(event:IOErrorEvent):void {
            Alert.show(event.text);
        }

        // Called when the user selects a file from disk
        public function doSelect( event:Event ):void
        {
            // Puts the name of the selected file into the UI
            txtPhoto.text = file.name;
            uploadButton.enabled = true;
        }

        // Called when the "Submit" button is clicked
        // Initiates file upload operation
        public function doSubmit( event:Event ):void
        {
            // Specify the endpoint for the upload operation
            // Create an object to hold additional data fields
            var request:URLRequest = new URLRequest( "/app/UploadExample" );
            var vars:URLVariables = new URLVariables();

            // Set the data fields as appropriate
            vars.userName = new String(User.getInstance().userName);
            vars.password = new String(User.getInstance().password);

            // Assign the data fields to the request
            request.data = vars;

            progressBar.visible = true;

            // Start the file upload process
            file.upload( request );
        }

        private function cancel():void {
            PopUpManager.removePopUp(this);
        }
    ]]>
	</mx:Script>
	<mx:RemoteObject id="uploadService" destination="userUpload">
		<mx:method name="create" result="created()"/>
	</mx:RemoteObject>
	<mx:HBox width="100%" height="100%" id="coreVBox" styleName="TitleWindowContents">
        <mx:Form id="coreForm" paddingRight="0">
            <mx:FormItem label="Name:" fontFamily="Tahoma" fontWeight="bold">
                <mx:TextInput id="feedName"/>
            </mx:FormItem>
            <mx:FormItem label="Select a file to upload:" direction="horizontal" fontFamily="Tahoma" fontWeight="bold">
                <mx:TextInput id="txtPhoto" editable="false"/>
                <mx:Button label="Browse..." click="doBrowse( event )" />
            </mx:FormItem>
            <mx:FormItem label="" direction="horizontal">
                <mx:Button label="Upload" click="doSubmit( event )" id="uploadButton" enabled="false"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="vertical">
                <mx:HBox horizontalAlign="center">
                    <mx:ProgressBar id="progressBar" visible="false" source="{file}"/>
                </mx:HBox>
                <mx:Label text="Upload successful!" visible="false" id="successMessage" fontFamily="Tahoma" fontWeight="bold"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="horizontal">
                <mx:Button label="Finish" click="next()" enabled="false" id="nextButton"/>
                <mx:Button label="Cancel" click="cancel()"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="vertical" visible="false" id="finishingSection">
                <mx:HBox horizontalAlign="center">
                    <mx:ProgressBar indeterminate="true"/>
                </mx:HBox>
                <mx:Label text="Creating the data source..." fontFamily="Tahoma" fontWeight="bold"/>
            </mx:FormItem>
        </mx:Form>
	    <mx:VBox>
            <mx:TextArea text="You can upload Excel (1997-2003) spreadsheets or comma or tab separated text files here. The file should have a header row, with data in the subsequent cells, as shown below:" borderThickness="0"
                    width="260" height="90" backgroundAlpha="0" editable="false"/>
            <mx:Image source="{excelImage}"/>
            <mx:TextArea width="260" height="50" text="You may experience unexpected results if the data does not match that pattern." borderThickness="0" backgroundAlpha="0" editable="false"/>
	    </mx:VBox>
	</mx:HBox>
    <mx:StringValidator id="nameValidator" source="{feedName}" minLength="3" property="text"/>
</mx:TitleWindow>
