<?xml version="1.0" encoding="utf-8"?>
<mx:TitleWindow xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="setup()">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.framework.Credentials;

        import com.easyinsight.framework.CredentialsCache;

        import mx.controls.Alert;
        import mx.events.CloseEvent;
        import mx.managers.PopUpManager;

        private function onKeyUp(event:KeyboardEvent):void {
            if (event.keyCode == Keyboard.ENTER) {
                save();
            }
        }

        private function setup():void {
            addEventListener(KeyboardEvent.KEY_UP, onKeyUp);
            focusManager.setFocus(userNameInput);
        }

        private var dataSourceID:int;

        [Bindable]
        private var dataSourceName:String;

        public function set requirement(requirement:CredentialRequirement):void {
            dataSourceID = requirement.dataSourceID;
            dataSourceName = requirement.dataSourceName;
        }

        private function save():void {
            progressBar.visible = true;
            var credentials:Credentials = new Credentials();
            credentials.userName = userNameInput.text;
            credentials.password = passwordInput.text;
            uploadService.validateCredentialsForID.send(dataSourceID, credentials);
        }

        private function validated():void {
            progressBar.visible = false;
            var validation:String = uploadService.validateCredentialsForID.lastResult as String;
            if (validation == null) {
                var credentials:Credentials = new Credentials();
                credentials.userName = userNameInput.text;
                credentials.password = passwordInput.text;
                CredentialsCache.getCache().addCredentials(dataSourceID, credentials);
                dispatchEvent(new CredentialsEvent(dataSourceID, credentials));
                PopUpManager.removePopUp(this);
            } else {
                Alert.show("The target SaaS system rejected these credentials with an error of \"" + validation + "\". Are you sure you want to go to the report editor?", "Failure",
                        Alert.OK | Alert.CANCEL, this, alertFeedListener, null, Alert.CANCEL);
            }
        }

        private function alertFeedListener(event:CloseEvent):void {
            if (event.detail == Alert.OK) {
                PopUpManager.removePopUp(this);
            }
        }
		]]>
	</mx:Script>
    <mx:RemoteObject destination="userUpload" id="uploadService">
        <mx:method name="validateCredentialsForID" result="validated()"/>
    </mx:RemoteObject>
    <mx:VBox>
        <mx:Label text="This data source requires runtime credentials." fontWeight="bold" fontFamily="Tahoma"/>
        <mx:Form>
            <mx:FormItem label="Data Source Name:" fontWeight="bold" fontFamily="Tahoma">
                <mx:Label text="{dataSourceName}" fontWeight="normal" fontFamily="Lucida Grande"/>
            </mx:FormItem>
            <mx:FormItem label="User Name: " direction="horizontal" fontWeight="bold" fontFamily="Tahoma">
                <mx:TextInput id="userNameInput" fontWeight="normal" fontFamily="Lucida Grande"/>
            </mx:FormItem>
            <mx:FormItem label="Password: " direction="horizontal" fontWeight="bold" fontFamily="Tahoma">
                <mx:TextInput id="passwordInput" displayAsPassword="true"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="vertical">
                <mx:ProgressBar id="progressBar" indeterminate="true" visible="false"/>
            </mx:FormItem>
            <mx:FormItem label="" direction="horizontal">
                <mx:Button label="Save" click="save()"/>
                <mx:Button label="Cancel" click="PopUpManager.removePopUp(this)"/>
            </mx:FormItem>
        </mx:Form>
    </mx:VBox>
</mx:TitleWindow>
