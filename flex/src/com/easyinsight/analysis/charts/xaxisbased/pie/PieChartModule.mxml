<?xml version="1.0" ?>
<mx:Module xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:analysis="com.easyinsight.analysis.*" implements="com.easyinsight.analysis.IReportRenderer"
        width="100%" height="100%" creationComplete="setupListeners()">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.analysis.AnalysisDefinition;

        import com.easyinsight.analysis.AnalysisItem;
        import com.easyinsight.analysis.CustomChangeEvent;
        import com.easyinsight.analysis.FillProvider;
        import com.easyinsight.filtering.FilterRawData;

        import com.easyinsight.pseudocontext.PseudoContextWindow;

        import mx.charts.ChartItem;
        import mx.charts.series.PieSeries;
        import mx.formatters.Formatter;
        import mx.charts.series.items.PieSeriesItem;
        import mx.charts.events.ChartItemEvent;
        import mx.collections.ArrayCollection;
        import mx.managers.PopUpManager;

        [Bindable]
        private var graphData:ArrayCollection = new ArrayCollection();

        [Bindable]
        private var dimension:String;

        [Bindable]
        private var measureName:String;

        private var measureFormatter:Formatter;

        [Bindable]
        private var explodeData:Array = [];

        private var dimensionItem:AnalysisItem;

        private function setupListeners():void {
        }

        public function renderReport(dataSet:ArrayCollection, analysisDefinition:AnalysisDefinition, clientProcessorMap:Object, additionalProperties:Object):void {
            var pieChartDef:PieChartDefinition = analysisDefinition as PieChartDefinition;
            graphData = dataSet;
            if (dataSet.length > 0) {
                labelPosition = pieChartDef.labelPosition;
                pieChart.setStyle("fontFamily", pieChartDef.fontName);
                pieChart.setStyle("fontSize", pieChartDef.fontSize);
                pieSeries.setStyle("fontFamily", pieChartDef.fontName);
                pieSeries.setStyle("fontSize", pieChartDef.fontSize);
                if (pieChartDef.colorScheme == FillProvider.spectral) {
                    pieSeries.setStyle("fills", FillProvider.createSpectralColors());
                } else if (pieChartDef.colorScheme == FillProvider.highContrast) {
                    pieSeries.setStyle("fills", FillProvider.createSAPColors());
                } else if (pieChartDef.colorScheme == FillProvider.warmColors) {
                    pieSeries.setStyle("fills", FillProvider.createWarmColors());
                } else {
                    pieSeries.setStyle("fills", FillProvider.createSampleGradient());
                }
                //StyleManager.getStyleDeclaration("UITextField");
                this.measureFormatter = pieChartDef.measure.getFormatter();
                measureName = pieChartDef.measure.qualifiedName();
                dimension = pieChartDef.xaxis.qualifiedName();
                this.dimensionItem = pieChartDef.xaxis;
            }
        }

        private function chartSelection(event:ChartItemEvent):void {
            for (var j:int = 0; j < graphData.length; j++) {
                var graphObj:Object = graphData.getItemAt(j);
                var explode:Boolean = false;
                for (var i:int = 0; i < pieChart.selectedChartItems.length; i++) {
                    var obj:PieSeriesItem = pieChart.selectedChartItems[i];
                    if (obj.item == graphObj) {
                        explode = true;
                    }
                }
                if (explode) {
                    explodeData[j] = .2;
                } else {
                    explodeData[j] = 0;
                }
            }
            var pieChartSeries:PieSeries = pieChart.series[0] as PieSeries;
            pieChartSeries.perWedgeExplodeRadius = explodeData;
        }

        private function renderPieLabel(data:Object, field:String, index:Number, percentValue:Number):String {
            return data[dimension] + ": " + '\n' + this.measureFormatter.format(data[measureName]);
        }

        private function onClick(event:ChartItemEvent):void {
            if (event.shiftKey) {

                var window:PseudoContextWindow = new PseudoContextWindow(dimensionItem, passThrough, this);
                window.data = event.hitData.item;
                PopUpManager.addPopUp(window, this);
                window.x = event.stageX + 5;
                window.y = event.stageY + 5;
            }
        }

        private function passThrough(event:Event):void {
            dispatchEvent(event);
        }

        public function createFilterRawData():FilterRawData {
            var filterRawData:FilterRawData = new FilterRawData();
            for (var i:int = 0; i < pieChart.selectedChartItems.length; i++) {
                var obj:ChartItem = pieChart.selectedChartItems[i];
                filterRawData.addPair(dimensionItem, obj.item[dimensionItem.key.createString()]);
            }
            return filterRawData;
        }


        public function updateExportMetadata():void {
        }

        public function onCustomChangeEvent(event:CustomChangeEvent):void {
        }

        public function preserveValues():Boolean {
            return false;
        }

        [Bindable]
        private var labelPosition:String;
		]]>
	</mx:Script><!--
    <mx:Array id="spectral">
        <mx:SolidColor color="0x9E0142" alpha="1"/>
        <mx:SolidColor color="0xE6F598" alpha="1"/>
        <mx:SolidColor color="0xD53E4F" alpha="1"/>
        <mx:SolidColor color="0xABDDA4" alpha="1"/>
        <mx:SolidColor color="0xF46D43" alpha="1"/>
        <mx:SolidColor color="0xFDAE61" alpha="1"/>
        <mx:SolidColor color="0x66C2A5" alpha="1"/>
        <mx:SolidColor color="0xFEE08B" alpha="1"/>
        <mx:SolidColor color="0x3288BD" alpha="1"/>
        <mx:SolidColor color="0xFFFFBF" alpha="1"/>





        <mx:SolidColor color="0x5E4FA2" alpha="1"/>
    </mx:Array>
    <mx:Array id="fills">
        <mx:SolidColor id="sc1" color="#F0B400" alpha="1"/>
        <mx:SolidColor id="sc2" color="#1E6C0B" alpha="1"/>
        <mx:SolidColor id="sc3" color="#00488C" alpha="1"/>
        <mx:SolidColor id="sc4" color="#332600" alpha="1"/>
        <mx:SolidColor id="sc5" color="#D84000" alpha="1"/>
        <mx:SolidColor id="sc6" color="#434C43" alpha="1"/>
        <mx:SolidColor id="sc7" color="#B00023" alpha="1"/>

        <mx:SolidColor id="sc8" color="#F3C01C" alpha="1"/>
        <mx:SolidColor id="sc15" color="#F8D753" alpha="1"/>
        <mx:SolidColor id="sc22" color="#FAE16B" alpha="1"/>
        <mx:SolidColor id="sc29" color="#FFF8A3" alpha="1"/>

        <mx:SolidColor id="sc9" color="#3D8128" alpha="1"/>
        <mx:SolidColor id="sc16" color="#5C9746" alpha="1"/>
        <mx:SolidColor id="sc23" color="#82B16A" alpha="1"/>
        <mx:SolidColor id="sc30" color="#A9CC8F" alpha="1"/>


        <mx:SolidColor id="sc10" color="#205F9A" alpha="1"/>
        <mx:SolidColor id="sc17" color="#3E75A7" alpha="1"/>
        <mx:SolidColor id="sc24" color="#779DBF" alpha="1"/>
        <mx:SolidColor id="sc31" color="#B2C8D9" alpha="1"/>


        <mx:SolidColor id="sc11" color="#63522B" alpha="1"/>
        <mx:SolidColor id="sc18" color="#7A653E" alpha="1"/>
        <mx:SolidColor id="sc25" color="#907A52" alpha="1"/>
        <mx:SolidColor id="sc32" color="#BEA37A" alpha="1"/>


        <mx:SolidColor id="sc12" color="#DC5313" alpha="1"/>
        <mx:SolidColor id="sc19" color="#E1662A" alpha="1"/>
        <mx:SolidColor id="sc26" color="#EB8953" alpha="1"/>
        <mx:SolidColor id="sc33" color="#F3AA79" alpha="1"/>


        <mx:SolidColor id="sc13" color="#5D645A" alpha="1"/>
        <mx:SolidColor id="sc20" color="#74796F" alpha="1"/>
        <mx:SolidColor id="sc27" color="#8A8D82" alpha="1"/>
        <mx:SolidColor id="sc34" color="#B5B5A9" alpha="1"/>


        <mx:SolidColor id="sc14" color="#BC1C39" alpha="1"/>
        <mx:SolidColor id="sc21" color="#C4384F" alpha="1"/>
        <mx:SolidColor id="sc28" color="#D6707B" alpha="1"/>
        <mx:SolidColor id="sc35" color="#E6A5A4" alpha="1"/>
    </mx:Array>-->
    <mx:HBox width="100%" height="100%">
        <mx:PieChart id="pieChart" dataProvider="{graphData}" selectionMode="multiple" height="100%" width="100%"
					paddingLeft="0" paddingRight="0" paddingTop="0" paddingBottom="0" itemClick="onClick(event)"
                showDataTips="true" fontFamily="Tahoma" fontSize="14">
            <mx:series>
                <mx:PieSeries field="{measureName}" nameField="{dimension}" labelPosition="{labelPosition}"
                    labelFunction="renderPieLabel" id="pieSeries">
                </mx:PieSeries>
            </mx:series>
        </mx:PieChart>
        <mx:Legend id="legend" dataProvider="{pieChart}" height="100%" legendItemClass="com.easyinsight.analysis.charts.EILegendItem"/>
    </mx:HBox>
</mx:Module>