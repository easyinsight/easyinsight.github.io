<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" creationComplete="gotFocus()">
	<mx:Script>
		<![CDATA[
        import com.easyinsight.util.PopUpUtil;

        import mx.managers.PopUpManager;
			import mx.collections.ArrayCollection;

            [Bindable]
            private var userButtonFactory:EditUserButtonFactory ;

			[Bindable]
			private var users:ArrayCollection;
            [Bindable]
			private var consultants:ArrayCollection;

        [Bindable]
        private var enableAdd:Boolean;

        [Bindable]
        private var usersAvailableString:String;

        [Bindable]
        private var usersUsedString:String;

        private var usersAvailable:int;
        private var usersUsed:int;

            public function gotFocus():void {
                usersGrid.addEventListener(RefreshAccountEvent.REFRESH_ACCOUNT, refreshAccount);
                usersGrid.addEventListener(DeleteUserEvent.DELETE_USER, deleteUser);
                userButtonFactory = new EditUserButtonFactory(this);
            	userService.getUsers.send();
                userService.getAccountStats.send();
            }

            private function deleteUser(event:DeleteUserEvent):void {
                userService.deleteUser.send(event.userID);
            }
            
			private function refreshAccount(event:RefreshAccountEvent):void {
				userService.getUsers.send();
                userService.getAccountStats.send();
			}            
            
            private function gotUsers():void {
            	users = userService.getUsers.lastResult as ArrayCollection;
            }
            
            private function addUser():void {
            	var newUserDialog:NewUserDialog = NewUserDialog(PopUpManager.createPopUp(this, NewUserDialog, true));
                newUserDialog.addEventListener(RefreshAccountEvent.REFRESH_ACCOUNT, refreshAccount);
            	PopUpUtil.centerPopUp(newUserDialog);
            }

            private function addGuestUser():void {
                var window:AddGuestUserWindow = new AddGuestUserWindow();
                window.addEventListener(RefreshAccountEvent.REFRESH_ACCOUNT, refreshAccount);
                PopUpManager.addPopUp(window, this, true);
                PopUpUtil.centerPopUp(window);
            }

            private function deletedUser():void {
                refreshAccount(null);
            }

            private function gotStats():void {
                var accountStats:AccountStats = userService.getAccountStats.lastResult as AccountStats;
                usersUsedString = String(accountStats.currentUsers);
                usersAvailableString = String(accountStats.availableUsers);
                usersUsed = accountStats.currentUsers;
                usersAvailable = accountStats.availableUsers;
                enableAdd = usersUsed < usersAvailable;
            }
        ]]>
	</mx:Script>
	<mx:RemoteObject destination="accountAdmin" id="userService">
		<mx:method name="getUsers" result="gotUsers()"/>
        <mx:method name="deleteUser" result="deletedUser()"/>
        <mx:method name="getAccountStats" result="gotStats()"/>
	</mx:RemoteObject>
	<mx:VBox width="100%" height="100%" horizontalAlign="center">
        <mx:VBox>
            <mx:Form paddingTop="5" paddingLeft="5">
                <mx:FormItem label="Account Users Used: " direction="horizontal">
                    <mx:Label text="{usersUsedString}" fontFamily="Lucida Grande" fontWeight="normal"/>
                    <mx:Label text=" / "/>
                    <mx:Label text="{usersAvailableString}" fontFamily="Lucida Grande" fontWeight="normal"/>
                </mx:FormItem>
            </mx:Form>
		<mx:HBox width="100%">
			<mx:Button label="Add User..." click="addUser()" enabled="{enableAdd}"/>
			<!-- <mx:Button label="Add Consultant" click="addGuestUser()"/> -->
		</mx:HBox>
        <mx:VBox id="accountSettingsBox" verticalGap="0" borderThickness="1" borderColor="#D42525" borderStyle="solid" dropShadowEnabled="true">
            <mx:Box width="100%" height="5" backgroundColor="#D42525" left="0" right="0"/>
            <mx:Box width="100%" backgroundColor="#F1EE8D" horizontalAlign="center">
                <mx:Label text="Users" fontFamily="Tahoma" fontWeight="bold" fontSize="14"/>
            </mx:Box>
            <mx:DataGrid dataProvider="{users}" width="100%" id="usersGrid">
                <mx:columns>
                    <mx:DataGridColumn dataField="userName" headerText="User Name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
                    <mx:DataGridColumn dataField="name" headerText="Full Name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
                    <mx:DataGridColumn dataField="userName" width="100" headerText="" itemRenderer="{userButtonFactory}"/>
                </mx:columns>
            </mx:DataGrid>
            <!--
            <mx:Spacer height="40"/>
            <mx:Box width="100%" backgroundColor="#F1EE8D" horizontalAlign="center">
                <mx:Label text="Consultants" fontFamily="Tahoma" fontWeight="bold" fontSize="14"/>
            </mx:Box>
            <mx:DataGrid dataProvider="{consultants}" width="100%" id="guestUsersGrid">
                <mx:columns>
                    <mx:DataGridColumn dataField="userName" headerText="User Name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
                    <mx:DataGridColumn dataField="name" headerText="Full Name" headerRenderer="com.easyinsight.groups.CustomGroupHeader"/>
                    <mx:DataGridColumn dataField="userName" width="100" headerText="" itemRenderer="{userButtonFactory}"/>
                </mx:columns>
            </mx:DataGrid>
            -->
        </mx:VBox>
            </mx:VBox>
	</mx:VBox>
</mx:Canvas>
