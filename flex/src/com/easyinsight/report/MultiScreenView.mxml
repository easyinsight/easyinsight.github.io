<?xml version="1.0" ?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:easyinsight="com.easyinsight.*"
        xmlns:util="com.easyinsight.util.*" width="100%" height="100%" creationComplete="onCreation()"
         implements="com.easyinsight.listing.IPerspective" verticalGap="0">
    <mx:Metadata>
        [Event(name="analysisClose", type="com.easyinsight.analysis.AnalysisCloseEvent")]
    </mx:Metadata>
    <mx:Script><![CDATA[
        import com.easyinsight.analysis.AnalysisCloseEvent;

        import com.easyinsight.framework.NavigationEvent;
        import com.easyinsight.framework.User;
        import com.easyinsight.quicksearch.EIDescriptor;

        import com.easyinsight.solutions.EmptyReportDescriptor;
        import com.easyinsight.solutions.Solution;
        import com.easyinsight.util.AsyncLoadEvent;

        import com.easyinsight.util.IAsyncScreenFactory;

        import mx.collections.ArrayCollection;

        import mx.controls.Label;
        import mx.events.ListEvent;

        [Bindable]
        [Embed(source="../../../../assets/background2.JPG")]
        private var background2:Class;

        private function onCreation():void {
            setupBrowser();
        }

        protected function setupBrowser():void {
        }

        public function set dataSourceID(value:int):void {
            _dataSourceID = value;
        }

        public function set dataSourceName(value:String):void {
            _dataSourceName = value;
        }

        protected var _dataSourceID:int;
        protected var _dataSourceName:String;

        [Bindable]
        private var _reports:ArrayCollection;


        private var _report:EIDescriptor;


        [Bindable(event="reportChanged")]
        public function get report():EIDescriptor {
            return _report;
        }

        public function set report(value:EIDescriptor):void {
            if (_report == value) return;
            _report = value;
            if (reports != null) {
                var index:int = reports.getItemIndex(report);
                reportsList.selectedIndex = index;
            }
            dispatchEvent(new Event("reportChanged"));
        }

        public function changeReport(value:EIDescriptor, properties:Object):void {
            viewStack.queuePropertiesForReport(value, properties);

            report = value;
        }

        private var _factory:IAsyncScreenFactory = new ReportScreenFactory();

        [Bindable]
        private var progressVisible:Boolean;

        [Bindable]
        [Embed(source="../../../../assets/document_out_x32.png")]
        private var closeIcon:Class;


        [Bindable(event="factoryChanged")]
        public function get factory():IAsyncScreenFactory {
            return _factory;
        }

        public function set factory(value:IAsyncScreenFactory):void {
            if (_factory == value) return;
            _factory = value;
            dispatchEvent(new Event("factoryChanged"));
        }

        public function set reports(value:ArrayCollection):void {
            _reports = value;
            if (_reports != null && _reports.length != 0) {
                report = value.getItemAt(0) as EIDescriptor;
            }
            else {
                report = new EmptyReportDescriptor(_dataSourceID, _dataSourceName);
            }
        }

        public function get reports():ArrayCollection {
            return _reports;
        }

        override protected function commitProperties():void {
            super.commitProperties();
        }

        private function onItemClick(event:ListEvent):void {
            onReportChange(reportsList.selectedItem as EIDescriptor);
        }

        private function onReportChange(descriptor:EIDescriptor):void {
            this.report = descriptor;
        }

        private function onLoading(event:AsyncLoadEvent):void {
            progressVisible = event.type == AsyncLoadEvent.LOAD_START;
        }

        private function close():void {
            dispatchEvent(new AnalysisCloseEvent(this));
        }

        private var _showBackButton:Boolean = true;


        override protected function createChildren():void {
            super.createChildren();
            if (!_showBackButton) {
                topBar.removeChild(backButton);
            }
            if (_solution != null) {
                var addLabel:Label = new Label();
                addLabel.text = "Want more reports for this solution?";
                verticalBarBox.addChild(addLabel);
                var addButton:Button = new Button();
                addButton.label = "Look at reports that other users have built";
                addButton.addEventListener(MouseEvent.CLICK, toExchange);
                verticalBarBox.addChild(addButton);
            }
        }

        private function toExchange(event:MouseEvent):void {
            var props:Object = new Object();
            props.viewMode = 1;
            props.displayMode = 0;
            props.solution = _solution;
            User.getEventNotifier().dispatchEvent(new NavigationEvent("Exchange", null, props));
        }

        private var _solution:Solution;

        public function set solution(value:Solution):void {
            _solution = value;
        }

        public function set showBackButton(value:Boolean):void {
            _showBackButton = value;
        }

        public function gotFocus():void {
        }

        public function cleanup():void {
        }]]></mx:Script>
    <mx:HBox width="100%" id="topBar" paddingBottom="10" paddingLeft="10" paddingRight="10" paddingTop="10" backgroundColor="#636363">
        <mx:Button label="Back" click="close()" icon="{closeIcon}" labelPlacement="bottom" id="backButton"/>
        <mx:TileList id="reportsList" width="100%" dataProvider="{_reports}" height="50"
                     itemRenderer="com.easyinsight.report.ReportButton" itemClick="onItemClick(event)" columnWidth="150"
                borderStyle="none" backgroundAlpha="0" selectionColor="#D42525" rollOverColor="#E57171"/>
    </mx:HBox>
    <mx:HBox width="100%" horizontalAlign="center" verticalAlign="middle" id="verticalBarBox"/>
    <mx:Box width="100%" height="5" backgroundColor="#D42525"/>
    <util:AsyncViewStack width="100%" height="100%" targetDescriptor="{report}" screenRenderer="{factory}"
            asyncLoadStart="onLoading(event)" asyncLoadSuccess="onLoading(event)" id="viewStack"/>
</mx:VBox>