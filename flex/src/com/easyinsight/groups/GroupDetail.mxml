<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:util="com.easyinsight.util.*"
         xmlns:listing="com.easyinsight.listing.*" xmlns:scorecards="com.easyinsight.scorecard.*" width="100%"
         height="100%"
         implements="com.easyinsight.listing.IPerspective"
         xmlns:groups="com.easyinsight.groups.*" xmlns:discussion="com.easyinsight.discussion.*"
         creationComplete="setup()" xmlns:viewStackEffects="org.efflex.mx.viewStackEffects.*">
    <mx:Script>
		<![CDATA[
        import com.easyinsight.discussion.MessagePostedEvent;
        import com.easyinsight.discussion.NewMessageWindow;
        import com.easyinsight.listing.DataFeedDescriptor;
        import com.easyinsight.listing.DeleteDataSourceEvent;
        import com.easyinsight.reportpackage.ReportPackageDescriptor;
        import com.easyinsight.solutions.InsightDescriptor;
        import com.easyinsight.util.PopUpUtil;
        import com.easyinsight.util.ProgressAlert;

        import mx.controls.Alert;
        import mx.effects.Effect;
        import mx.events.CloseEvent;
        import mx.managers.BrowserManager;
        import mx.managers.PopUpManager;

        import com.easyinsight.help.HelpWindow;
        import com.easyinsight.framework.User;

        import mx.collections.ArrayCollection;

        import com.easyinsight.framework.NavigationEvent;

        import mx.utils.URLUtil;

        [Bindable]
        [Embed(source="../../../../assets/helpx48.png")]
        public var helpIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/message.png")]
        public var messageIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/data_add_x64.png")]
        public var addDataSourceIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/chart_pie2_48x48.png")]
        public var addInsightIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/branch_add.png")]
        public var addGoalTreeIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/arrow2_up_green_x48.png")]
        public var addGoalIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/earth_connection.png")]
        public var connectIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/earth_edit.png")]
        public var administerIcon:Class;

        [Bindable]
        public var groupID:int;
        [Bindable]
        public var description:String;

        [Bindable]
        private var hasDescription:Boolean = false;

        [Bindable]
        private var groupName:String;

        [Bindable]
        private var recentChanges:ArrayCollection;

        [Bindable]
        private var messages:ArrayCollection;

        [Bindable]
        private var recentChangesRowCount:int;

        [Bindable]
        private var groupUsers:ArrayCollection;

        [Bindable]
        private var ownerLabel:String = "Group Owner:";

        [Bindable]
        private var adminEnabled:Boolean = false;

        [Bindable]
        private var joinEnabled:Boolean = false;

        [Bindable]
        private var ownerText:String;

        [Bindable]
        private var numberMembersText:String;

        [Bindable]
        private var goals:ArrayCollection;

        [Bindable]
        private var goalTrees:ArrayCollection;

        [Bindable]
        private var _group:Group;

        [Bindable]
        private var reportItemFactory:ClassFactory = new ClassFactory(GroupReportItem);
        [Bindable]
        private var dataSourceItemFactory:ClassFactory = new ClassFactory(GroupDataSourceItem);
        [Bindable]
        private var goalTreeFactory:ClassFactory = new ClassFactory(GoalTreeNameRenderer);


        private function setup():void {
            addEventListener(RemoveItemFromGroupEvent.REMOVE_DATA_SOURCE_FROM_GROUP, removeFromGroup);
            addEventListener(RemoveItemFromGroupEvent.REMOVE_REPORT_FROM_GROUP, removeFromGroup);
            addEventListener(RemoveItemFromGroupEvent.REMOVE_GOAL_TREE_FROM_GROUP, removeFromGroup);
            addEventListener(RemoveItemFromGroupEvent.REMOVE_GOAL_FROM_GROUP, removeFromGroup);
            addEventListener(DeleteDataSourceEvent.DELETE_DATA_SOURCE, onDelete);
        }

        private function onDelete(event:DeleteDataSourceEvent):void {
            deleteItem(event.descriptor);
        }

        private function deleteItem(selectedItem:Object):void {
            this.selectedItem = selectedItem;
            if (selectedItem is DataFeedDescriptor) {
                Alert.show("Are you sure you want to remove this data source from the group?", "Alert",
                        Alert.OK | Alert.CANCEL, this, alertFeedListener, null, Alert.CANCEL);
            } else if (selectedItem is InsightDescriptor) {
                Alert.show("Are you sure you want to remove this report from the group?.", "Alert",
                        Alert.OK | Alert.CANCEL, this, alertInsightListener, null, Alert.CANCEL);
            } else if (selectedItem is ReportPackageDescriptor) {
                Alert.show("Are you sure you want to remove this package from the group?", "Alert",
                        Alert.OK | Alert.CANCEL, this, alertPackageListener, null, Alert.CANCEL);
            }
        }

        private var selectedItem:Object;

         private function alertFeedListener(event:CloseEvent):void {
            if (event.detail == Alert.OK) {
                var feedDescriptor:DataFeedDescriptor = selectedItem as DataFeedDescriptor;
                ProgressAlert.alert(this, "Removing data source...", null, groupService.removeDataSourceFromGroup);
                groupService.removeDataSourceFromGroup.send(feedDescriptor.dataFeedID, groupID);
            }
        }

        private function alertPackageListener(event:CloseEvent):void {
            if (event.detail == Alert.OK) {
                /*var reportDescriptor:ReportPackageDescriptor = uploadGrid.selectedItem as ReportPackageDescriptor;
                ProgressAlert.alert(this, "Deleting package...", "Deleted package!", packageService.deleteReportPackage);
                packageService.deleteReportPackage.send(reportDescriptor.id);*/
            }
        }

        private function alertInsightListener(event:CloseEvent):void {
            if (event.detail == Alert.OK) {
                var definition:InsightDescriptor = selectedItem as InsightDescriptor;
                ProgressAlert.alert(this, "Removing report...", null, groupService.removeReportFromGroup);
                groupService.removeReportFromGroup.send(definition.id, groupID);
            }
        }        

        public function gotFocus():void {
            var fragmentObject:Object = new Object();
            fragmentObject.groupID = String(groupID);
            var fragmentString:String = URLUtil.objectToString(fragmentObject);
            BrowserManager.getInstance().setFragment(fragmentString);
            ProgressAlert.alert(this, "Retrieving group data...", null, groupService.getGroup, groupService.getGroupMessages);
            groupService.getGroup.send(groupID);
            groupService.getGroupMessages.send(groupID, null, null);            
            groupData.gotFocus();
        }

        private function backToGroupList():void {
            User.getEventNotifier().dispatchEvent(new NavigationEvent("Groups"));
        }

        private function gotGroupDetails():void {
            var group:Group = groupService.getGroup.lastResult as Group;

            groupName = group.name;
            BrowserManager.getInstance().setTitle("Easy Insight - " + group.name);

            var foundUser:Boolean = false;
            for each (var groupUser:GroupUser in group.groupUsers) {
                if (groupUser.role == GroupUser.OWNER) {
                    if (groupUser.name == User.getInstance().userName) {
                        adminEnabled = true;
                    }
                }
                if (groupUser.name == User.getInstance().userName) {
                    foundUser = true;
                }
            }

            reportItemFactory = new ClassFactory(GroupReportItem);
            reportItemFactory.properties = { admin: adminEnabled };
            dataSourceItemFactory = new ClassFactory(GroupDataSourceItem);
            dataSourceItemFactory.properties = { admin: adminEnabled };

            if (!foundUser) {
                joinEnabled = true;
            }
            
            numberMembersText = group.groupUsers.length > 1 ? (group.groupUsers.length + " members") : (group.groupUsers.length + " member");
            this._group = group;
        }

        private function help():void {
            HelpWindow.createHelpWindow(GroupHelp, this);
        }

        private function groupUpdated(event:GroupCreatedEvent):void {
            gotFocus();
        }

        

        private function joinGroup():void {
            groupService.addMemberToGroup.send(_group.groupID);
        }

        private function addedToGroup():void {
            numberMembersText = (_group.groupUsers.length) + _group.groupUsers.length + " members";
            joinEnabled = false;
            Alert.show("You are now a member of this group.");
        }

        private function gotGroupMessages():void {
            this.messages = groupService.getGroupMessages.lastResult as ArrayCollection;
        }

        private function newMessage():void {
            var newMessageWindow:NewMessageWindow = new NewMessageWindow();
            newMessageWindow.addEventListener(MessagePostedEvent.MESSAGE_POSTED, onMessagePost);
            PopUpManager.addPopUp(newMessageWindow, this);
            PopUpUtil.centerPopUp(newMessageWindow);
        }

        private function onMessagePost(event:MessagePostedEvent):void {
            var groupComment:GroupComment = new GroupComment();
            groupComment.message = event.message;
            groupComment.timestamp = new Date();
            groupComment.groupID = _group.groupID;
            groupService.addGroupComment.send(groupComment);
        }

        private function addedComment():void {
            groupService.getGroupMessages.send(_group.groupID);
        }



        private function onGroupRefresh(event:GroupRefreshEvent):void {

        }

        private function removeFromGroup(event:RemoveItemFromGroupEvent):void {
            if (event.type == RemoveItemFromGroupEvent.REMOVE_DATA_SOURCE_FROM_GROUP) {
                groupService.removeDataSourceFromGroup.send(event.id, groupID);
            } else if (event.type == RemoveItemFromGroupEvent.REMOVE_REPORT_FROM_GROUP) {
                groupService.removeReportFromGroup.send(event.id, groupID);
            } else if (event.type == RemoveItemFromGroupEvent.REMOVE_GOAL_TREE_FROM_GROUP) {
                groupService.removeGoalTreeFromGroup.send(event.id, groupID);
            } else if (event.type == RemoveItemFromGroupEvent.REMOVE_GOAL_FROM_GROUP) {
                groupService.removeGoalFromGroup.send(event.id, groupID);
            }
        }

        private function removed():void {
            groupData.gotFocus();
        }

        public function cleanup():void {
        }

        [Bindable]
        private var changeEffect:Effect = rightEffect;

        private function blah():void {
            viewStack.selectedIndex = buttonBar.selectedIndex;
        }
		]]>		
    </mx:Script>
    <mx:RemoteObject destination="groupService" id="groupService2">
        <mx:method name="getInsights"/>
        <mx:method name="getFeeds"/>
    </mx:RemoteObject>
    <mx:RemoteObject destination="groupService" id="groupService">
        <mx:method name="getGroup" result="gotGroupDetails()"/>
        <mx:method name="getGroupMessages" result="gotGroupMessages()"/>
        <mx:method name="addMemberToGroup" result="addedToGroup()"/>
        <mx:method name="addGroupComment" result="addedComment()"/>
        <mx:method name="removeReportFromGroup" result="removed()"/>
        <mx:method name="removeDataSourceFromGroup" result="removed()"/>
        <mx:method name="removeGoalTreeFromGroup" result="removed()"/>
        <mx:method name="removeGoalFromGroup" result="removed()"/>
    </mx:RemoteObject>
    <!--
        a few things we have to address:

        what actually shows up in the group screen
            scorecards
        for non-admin users
            persona concept?
            
    -->
    <viewStackEffects:CoverFlowPapervision3D id="leftEffect" direction="horizontal"/>
    <viewStackEffects:Slide id="rightEffect" direction="right"/>
    <mx:Canvas width="100%" height="100%">
        <mx:VBox width="100%" height="100%" verticalGap="0">
        <mx:Canvas height="50%" width="100%" backgroundColor="#888888"/>
        <mx:Canvas height="50%" width="100%" backgroundColor="#000000"/>
        </mx:VBox>
    <mx:VBox width="100%" height="100%" id="primaryCanvas" paddingTop="10" paddingLeft="10" paddingRight="10"
             paddingBottom="10" horizontalAlign="center">
        <mx:Label text="{groupName}" fontSize="20" color="#FFFFFF" fontFamily="Tahoma" fontWeight="bold"/>
        <mx:VBox width="1020" horizontalAlign="center" backgroundColor="#FFFFFF" height="100%" paddingTop="10">
            <mx:ToggleButtonBar id="buttonBar" itemClick="blah()">
                <mx:dataProvider>
                    <mx:Array>
                        <mx:String>Scorecards</mx:String>
                        <mx:String>Messages</mx:String>
                        <mx:String>Data Sources and Reports</mx:String>
                        <mx:String>Info</mx:String>
                        <mx:String>Members</mx:String>
                    </mx:Array>
                </mx:dataProvider>
            </mx:ToggleButtonBar>
            <mx:ViewStack width="100%" creationPolicy="all" resizeToContent="true"
                    paddingLeft="10" paddingBottom="10" paddingRight="10" paddingTop="10" id="viewStack">
                <scorecards:ScorecardGroupDisplay groupID="{groupID}" label="Scorecards" hideEffect="leftEffect" showEffect="leftEffect"/>
                <discussion:DiscussionPanel dataProvider="{messages}" width="100%" label="Messages" hideEffect="leftEffect" showEffect="leftEffect"/>
                <groups:GroupMyData groupID="{groupID}" label="Data Sources and Reports" groupAdmin="{adminEnabled}" id="groupData" hideEffect="leftEffect" showEffect="leftEffect"/>
                <groups:GroupInfo group="{_group}" label="Info" groupAdmin="{adminEnabled}" hideEffect="leftEffect" showEffect="leftEffect"/>
                <groups:ManageGroupUsers groupID="{groupID}" id="manageUsers" label="Members" groupAdmin="{adminEnabled}" hideEffect="leftEffect" showEffect="leftEffect"/>
            </mx:ViewStack>
        </mx:VBox>

    </mx:VBox>
    </mx:Canvas>
</mx:VBox>
