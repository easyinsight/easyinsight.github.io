<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:listing="com.easyinsight.listing.*"
         xmlns:goals="com.easyinsight.goals.*" xmlns:util="com.easyinsight.util.*"
         implements="com.easyinsight.listing.IPerspective" creationComplete="onCreation()" width="100%" height="100%"
         doubleClickEnabled="true" verticalGap="0">
    <mx:states>
        <mx:State name="notLoggedIn">
            <mx:RemoveChild target="{controlsBox}"/>
            <mx:RemoveChild target="{goalTreesBox}"/>
            <mx:RemoveChild target="{kpiBox}"/>
            <!--<mx:RemoveChild target="{dataBoxes}"/>-->
            <mx:RemoveChild target="{coreContent}" />
            <mx:AddChild relativeTo="{wholePage}">
                <mx:VBox width="100%" height="100%" backgroundColor="#DCE2F8">
                    <mx:VBox height="100%" width="100%" paddingTop="10" paddingLeft="10" paddingRight="10" paddingBottom="10" verticalGap="10">
                        <listing:GottaLoginPage/>
                    </mx:VBox>
                </mx:VBox>
            </mx:AddChild>
        </mx:State>
        <mx:State name="functionalityUnavailable">
            <mx:RemoveChild target="{controlsBox}"/>
            <!--<mx:RemoveChild target="{dataBoxes}"/>-->
            <mx:RemoveChild target="{goalTreesBox}"/>
            <mx:RemoveChild target="{kpiBox}"/>
            <mx:AddChild relativeTo="{coreContent}">
                <goals:GoalFunctionalityUnavailable/>
            </mx:AddChild>
        </mx:State>
        <mx:State name="noGoalsIndividual">
            <mx:RemoveChild target="{controlsBox}"/>
            <mx:RemoveChild target="{goalTreesBox}"/>
            <mx:RemoveChild target="{kpiBox}"/>
            <!--<mx:RemoveChild target="{dataBoxes}"/>-->
            <mx:AddChild relativeTo="{coreContent}">
                <mx:VBox width="100%">
                    <mx:HBox width="100%">
                        <mx:Image source="{screenshot}"/>
                        <mx:VBox height="100%" width="100%" verticalAlign="middle">
                            <mx:TextArea editable="false" text="KPI trees provide you with a broad strategic view of your improvement on key metrics. Starting with a high level overall goal, you repeatedly subdivide into the various lower level key performance indicators that will bring you closer to achieving that overall goal."
                                    borderStyle="none" width="100%" fontSize="14" height="160"/>
                        </mx:VBox>
                    </mx:HBox>
                    <mx:HBox width="100%" paddingLeft="30" paddingRight="30">
                        <mx:TextArea editable="false"  text="You can't use any of the KPI functionality with your account level. You'll have to upgrade to Group or higher for access to the functionality."
                                width="100%" borderStyle="none" fontSize="14"/>
                    </mx:HBox>
                </mx:VBox>
            </mx:AddChild>
        </mx:State>
        <mx:State name="noGoalsPro">
            <mx:RemoveChild target="{goalTreesBox}"/>            
            <mx:RemoveChild target="{kpiBox}"/>
            <!--<mx:RemoveChild target="{dataBoxes}"/>-->
            <mx:AddChild relativeTo="{coreContent}">
                <mx:VBox width="100%" verticalGap="15">
                    <mx:HBox width="100%" horizontalGap="10">
                        <mx:Image source="{screenshot}"/>
                        <mx:VBox height="100%" width="100%" verticalAlign="middle">
                            <mx:TextArea editable="false"  text="KPI trees provide you with a broad strategic view of your improvement on key metrics. Starting with a high level overall goal, you repeatedly subdivide into the various lower level key performance indicators that will bring you closer to achieving that overall goal."
                                    borderStyle="none" width="100%" fontSize="14" height="150"/>
                        </mx:VBox>
                    </mx:HBox>
                    <mx:HBox width="100%" paddingLeft="30" paddingRight="30">
                        <mx:TextArea editable="false"  text="You can start by importing KPI trees from solutions or by clicking Add KPI Tree... above. From there, you can customize the tree, altering template goals to match your specific scenarios, dragging in additional trees to rapidly build out a tree, and associating relevant data sources and reports to goals."
                            width="100%" borderStyle="none" fontSize="14" height="60"/>
                    </mx:HBox>
                </mx:VBox>
            </mx:AddChild>
        </mx:State>
    </mx:states>
    <mx:Script>
		<![CDATA[
        import com.easyinsight.account.Account;
        import com.easyinsight.kpi.KPIEvent;
        import com.easyinsight.util.PopUpUtil;

        import mx.controls.Alert;
        import mx.events.CloseEvent;
        import mx.events.DividerEvent;
        import mx.events.ListEvent;

        import mx.managers.PopUpManager;
        import mx.utils.URLUtil;
        import mx.managers.BrowserManager;

        import com.easyinsight.framework.LoginEvent;
        import com.easyinsight.framework.User;
        import com.easyinsight.listing.AnalyzeSource;
        import com.easyinsight.genredata.AnalyzeEvent;
        import com.easyinsight.util.ProgressAlert;

        import mx.collections.ArrayCollection;

        private function onGoalDetail(event:GoalDetailEvent):void {
            dispatchEvent(new AnalyzeEvent(new GoalDetailAnalyzeSource(event.goalTreeNodeData)));
        }

        private var deleteID:int;

        [Bindable]
        private var addGoalTreeAvailable:Boolean = false;

        private var fileRef:FileReference;

        [Bindable]
        private var goalTrees:ArrayCollection;

        [Bindable]
        private var myGoals:ArrayCollection;

        [Bindable]
        [Embed(source="../../../../assets/branch_add.png")]
        public var addIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/document_gear.png")]
        public var downloadYahooWidget:Class;

        [Bindable]
        [Embed(source="../../../../assets/calendar_list.png")]
        public var calendarIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/goalsscreenshot.JPG")]
        public var screenshot:Class;

        private function createGoalTree():void {
            dispatchEvent(new AnalyzeEvent(new GoalTreeAdminAnalyzeSource(0)));
        }

        public function analyze():AnalyzeSource {
            return null;
        }

        private function onDividerRelease(event:DividerEvent):void {
            /*if (User.getSharedObject() != null) {
                User.getSharedObject().data.goalSliderPos = dataBoxes.getDividerAt(0).y + event.delta;
                User.getSharedObject().flush();
            }*/
        }

        private function onCreation():void {
            User.getEventNotifier().addEventListener(LoginEvent.LOGIN, onLogin);
            User.getEventNotifier().addEventListener(LoginEvent.LOGOUT, onLogin);
            //dataBoxes.addEventListener(DividerEvent.DIVIDER_RELEASE, onDividerRelease);
            addEventListener(DeleteGoalTreeEvent.DELETE_GOAL_TREE, onDelete);
            addEventListener(KPIEvent.KPI_ADDED, onKPIChange);
            addEventListener(KPIEvent.KPI_REMOVED, onKPIChange);
        }

        private function onKPIChange(event:KPIEvent):void {
            kpiService.getKPIs.send();
        }

        private function onDelete(event:DeleteGoalTreeEvent):void {
            deleteID = event.goalTree.id;
            Alert.show("Are you sure you want to delete the KPI tree?", "Alert",
                    Alert.OK | Alert.CANCEL, this, alertListener, null, Alert.CANCEL);
        }

        private function alertListener(event:CloseEvent):void {
            if (event.detail == Alert.OK) {
                ProgressAlert.alert(this, "Deleting goal tree...", "Deleted KPI tree!", goalService.deleteGoalTree);
                goalService.deleteGoalTree.send(deleteID);
            }
        }

        private function onLogin(event:LoginEvent):void {
            gotFocus();
        }

        public function gotFocus():void {
            var fragmentObject:Object = new Object();
            fragmentObject.page = "myGoals";
            BrowserManager.getInstance().setTitle("Easy Insight - Goals");
            var fragmentString:String = URLUtil.objectToString(fragmentObject);
            BrowserManager.getInstance().setFragment(fragmentString);
            var user:User = User.getInstance();
            if (user == null) {
                currentState = "notLoggedIn";
            } else {
                if (User.getInstance().getAccountType() == Account.FREE) {
                    currentState = "functionalityUnavailable";
                } else {
                    if (currentState != "") {
                        currentState = "";
                    }
                    addGoalTreeAvailable = User.getInstance().getAccountType() >= Account.GROUP;
                    goalService.getGoalTrees.send();
                    kpiService.getKPIs.send();
                    //myGoalsGrid.gotFocus();
                }
            }
        }

        private function deletedTree():void {
            goalService.getGoalTrees.send();
        }

        public function getDefaultAnalyzeState():Boolean {
            return false;
        }

        public function isKeywordSearchInstant():Boolean {
            return false;
        }

        private function netvibes():void {
            flash.net.navigateToURL(new URLRequest("http://www.netvibes.com/subscribe.php?module=UWA&moduleUrl=" + escape("https://www.easy-insight.com/app/widgets/UWAGoalsWidget.html")));
        }

        private function igoogle():void {
            flash.net.navigateToURL(new URLRequest("http://www.google.com/ig/add?moduleurl=" + escape("http://www.netvibes.com/api/uwa/compile/google.php?moduleUrl=" + escape("https://www.easy-insight.com/app/widgets/UWAGoalsWidget.html"))));
        }

        private function gotTrees():void {
            goalTrees = goalService.getGoalTrees.lastResult as ArrayCollection;
            kpiTreeCount = Math.min(10, goalTrees.length);
            if (goalTrees.length == 0) {
                if (User.getInstance().getAccountType() == Account.INDIVIDUAL) {
                    currentState = "noGoalsIndividual";
                } else {
                    currentState = "noGoalsPro";
                }
            }
            /*try {
                if (User.getSharedObject().data.goalSliderPos != null) {
                    dataBoxes.getDividerAt(0).y = User.getSharedObject().data.goalSliderPos;
                }
            } catch(e:Error) {
            }*/
        }

        private function gridDoubleClick(event:ListEvent):void {
            if (goalTreesBox.selectedItem != null) {
                var goalTree:GoalTreeDescriptor = goalTreesBox.selectedItem as GoalTreeDescriptor;
                dispatchEvent(new AnalyzeEvent(new GoalTreeAdminAnalyzeSource(goalTree.id)));
            }
        }

        private function downloadWidget():void {

            fileRef = new FileReference();

            var request:URLRequest = new URLRequest("/app/assets/goalswidget.widget");
            request.method = URLRequestMethod.GET;

            fileRef = new FileReference();
            fileRef.addEventListener(Event.CANCEL, doEvent);
            fileRef.addEventListener(Event.COMPLETE, complete);
            fileRef.addEventListener(Event.OPEN, doEvent);
            fileRef.addEventListener(Event.SELECT, doEvent);
            fileRef.addEventListener(HTTPStatusEvent.HTTP_STATUS, doEvent);
            fileRef.addEventListener(IOErrorEvent.IO_ERROR, doEvent);
            fileRef.addEventListener(ProgressEvent.PROGRESS, doEvent);
            fileRef.addEventListener(SecurityErrorEvent.SECURITY_ERROR, doEvent);

            fileRef.download(request, "goalswidget.widget");
        }

        private function complete(event:Event):void {
            Alert.show("This downloaded widget will allow you to see your monitored KPIs. You can add it to your widgets by selecting Open Widget... from your Yahoo Widgets dock.");
            fileRef = null;
        }

        private function doEvent(event:Event):void {
        }

        private function manageMilestones():void {
            var window:MilestonesWindow = new MilestonesWindow();
            PopUpManager.addPopUp(window, this, true);
            PopUpUtil.centerPopUp(window);
        }

        public function cleanup():void {
        }

        [Bindable]
        private var kpis:ArrayCollection;

        private function gotKPIs():void {
            kpis = kpiService.getKPIs.lastResult as ArrayCollection;
            kpiCount = Math.min(kpis.length, 10);
        }

        [Bindable]
        private var kpiCount:int;

        [Bindable]
        private var kpiTreeCount:int;
		]]>
    </mx:Script>
    <mx:RemoteObject destination="goalService" id="goalService">
        <mx:method name="getGoalTrees" result="gotTrees()"/>
        <mx:method name="deleteGoalTree" result="deletedTree()"/>
    </mx:RemoteObject>
    <mx:RemoteObject destination="kpiService" id="kpiService">
        <mx:method name="getKPIs" result="gotKPIs()"/>
    </mx:RemoteObject>
    <mx:VBox id="wholePage" height="100%" width="100%" backgroundColor="#818285" horizontalAlign="center">
        <mx:VBox width="1000" height="100%" paddingTop="10" paddingBottom="10" paddingLeft="10"
                 paddingRight="10" verticalGap="10" backgroundColor="#ffffff" id="coreContent">
            <mx:HBox width="100%" id="controlsBox">
                <mx:Button toolTip="Add KPI Tree..." click="createGoalTree()" id="uploadButton" icon="{addIcon}"
                           label="Add KPI Tree" labelPlacement="bottom" visible="{addGoalTreeAvailable}"/>
                <mx:Button toolTip="Manage Milestones..." click="manageMilestones()" id="milestonesButton" icon="{calendarIcon}"
                           label="Milestones" labelPlacement="bottom"/>
                <!--<mx:Button icon="@Embed('../../../../assets/helpx48.png')" label="Help..." labelPlacement="bottom"/>-->
            </mx:HBox>

            <mx:DataGrid dataProvider="{kpis}" id="kpiBox" width="100%" rowHeight="28">
                <mx:columns>
                    <util:EIDataGridColumn headerText="KPI Name" dataField="name"/>
                    <util:EIDataGridColumn headerText="" dataField="name" sortable="false"
                                       itemRenderer="com.easyinsight.kpi.KPIControls" width="150"/>
                </mx:columns>
            </mx:DataGrid>
            <mx:DataGrid dataProvider="{goalTrees}" width="100%" id="goalTreesBox"
                     itemDoubleClick="gridDoubleClick(event)" rowHeight="28">
                <mx:columns>
                    <util:EIDataGridColumn headerText="KPI Tree Name" dataField="name"/>
                    <util:EIDataGridColumn headerText="" dataField="goalTreeName" width="150"
                                           itemRenderer="com.easyinsight.goals.MyGoalsControls" sortable="false"/>
                </mx:columns>
            </mx:DataGrid>
                <!--<mx:VBox height="100%" width="100%">
                    <mx:HBox>
                        <mx:Button id="igoogleButton" toolTip="Add to iGoogle"
                           icon="@Embed(source='../../../../assets/uwa-google.png')" click="igoogle()" />
                        <mx:Button id="netvibesButton" toolTip="Add to Netvibes"
                           icon="@Embed(source='../../../../assets/uwa-netvibes.png')" click="netvibes()" />
                    </mx:HBox>
                </mx:VBox>-->
            
        </mx:VBox>
    </mx:VBox>
</mx:VBox>
