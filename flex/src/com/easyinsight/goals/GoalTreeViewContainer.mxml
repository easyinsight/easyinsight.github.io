<?xml version="1.0" ?>
<FullScreenPage xmlns="com.easyinsight.*" xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:ilog="ilog.orgchart.*"
                xmlns:goals="com.easyinsight.goals.*" width="100%" height="100%" creationComplete="setup()" backgroundColor="#DCE2F8"
         implements="com.easyinsight.util.IAsyncScreen">
    <mx:Script><![CDATA[
        import com.easyinsight.analysis.AnalysisCloseEvent;
        import com.easyinsight.genredata.AnalyzeEvent;
        import com.easyinsight.util.ModelessWindowEvent;

        import com.easyinsight.util.ProgressAlert;

        import mx.collections.ArrayCollection;
        import mx.core.Container;
        import mx.core.IFlexDisplayObject;
        import mx.managers.BrowserManager;
        import mx.managers.PopUpManager;
        import mx.utils.URLUtil;

        [Bindable]
        [Embed(source="../../../../assets/background2.JPG")]
        private var background2:Class;

        [Bindable]
        [Embed(source="../../../../assets/document_out_x32.png")]
        private var closeIcon:Class;

        private var _goalTreeID:int;

        [Bindable]
        private var _goalTreeNodes:GoalTreeNode;

        private var goalTree:GoalTree;

        [Bindable]
        public var startDate:Date;

        [Bindable]
        public var endDate:Date;

        private var windows:ArrayCollection = new ArrayCollection();

        public function set goalTreeID(val:int):void {
            _goalTreeID = val;
        }

        private function setup():void {
            addEventListener(ModelessWindowEvent.WINDOW_REMOVED, onWindowRemove);
            addEventListener(ModelessWindowEvent.WINDOW_ADDED, onWindowAdd);
            var feedFragmentObject:Object = new Object();
            feedFragmentObject.goalTreeID = String(_goalTreeID);
            var feedFragmentString:String = URLUtil.objectToString(feedFragmentObject);
            BrowserManager.getInstance().setFragment(feedFragmentString);
            ProgressAlert.alert(this, "Retrieving latest goal data", null, goalService.createDataTree);
            goalService.createDataTree.send(_goalTreeID, startChooser.selectedDate, endChooser.selectedDate);
        }

        private function onWindowRemove(event:ModelessWindowEvent):void {
            windows.removeItemAt(windows.getItemIndex(event.displayObject));
        }

        private function onWindowAdd(event:ModelessWindowEvent):void {
            windows.addItem(event.displayObject);
        }

        override protected function createChildren():void {
            super.createChildren();
            endDate = new Date();
            startDate = new Date(endDate.getTime() - (1000 * 60 * 60 * 24 * 7));
        }

        override protected function commitProperties():void {
            //goalTree = goalService.createDataTree.lastResult as GoalTree;

            //myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function onDatesChanged():void {
            ProgressAlert.alert(this, "Retrieving latest goal data", null, goalService.createDataTree);
            goalService.createDataTree.send(_goalTreeID, startChooser.selectedDate, endChooser.selectedDate);
        }

        private function parentTreeClick(event:MouseEvent):void {
            var descriptor:GoalTreeDescriptor = event.currentTarget.data;
            dispatchEvent(new AnalyzeEvent(new GoalDataAnalyzeSource(descriptor.id)));
        }

        private function gotTree():void {
            goalTree = goalService.createDataTree.lastResult as GoalTree;
            if (goalTree.subTreeParents != null) {
                for each (var descriptor:GoalTreeDescriptor in goalTree.subTreeParents) {
                    var button:Button = new Button();
                    button.label = descriptor.name;
                    button.data = descriptor;
                    button.addEventListener(MouseEvent.CLICK, parentTreeClick);
                    parentsBox.addChild(button);
                }
            }
            _goalTreeNodes = goalTree.rootNode;
            myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function close():void {
            for each (var displayObject:DisplayObject in windows) {
                PopUpManager.removePopUp(displayObject as IFlexDisplayObject);
            }
            dispatchEvent(new AnalysisCloseEvent(this));
        }

        public function getContainer():Container {
            return this;
        }

        public function refreshData():void {
        }]]></mx:Script>
    <mx:RemoteObject destination="goalService" id="goalService">
        <mx:method name="createDataTree" result="gotTree()"/>
    </mx:RemoteObject>
    <mx:HBox id="buttonBox" paddingLeft="5" paddingTop="5" paddingBottom="5" width="100%">
        <mx:Button id="wrapButton" icon="{closeIcon}" click="close()" toolTip="Close"/>
        <mx:VBox id="parentsBox"/>
        <mx:HBox width="100%" horizontalAlign="center">
            <mx:DateField id="startChooser" selectedDate="{startDate}" change="onDatesChanged()"/>
            <mx:Spacer width="200"/>
            <mx:DateField id="endChooser" selectedDate="{endDate}" change="onDatesChanged()"/>
        </mx:HBox>
    </mx:HBox>
    <mx:VBox width="100%" height="100%" paddingRight="15" paddingTop="15" paddingLeft="15" paddingBottom="15">
        <mx:Canvas height="100%" width="100%" backgroundImage="{background2}" backgroundSize="100%">
            <ilog:OrgChart id="myOrgChart" dataProvider="{_goalTreeNodes}"
                           width="100%" height="100%" minZoomLevel="1" maxZoomLevel="1" allowSelection="false">
                <ilog:itemRenderer>
                    <mx:Component>
                        <goals:GoalDataRenderer/>
                    </mx:Component>
                </ilog:itemRenderer>
            </ilog:OrgChart>
        </mx:Canvas>
    </mx:VBox>

</FullScreenPage>