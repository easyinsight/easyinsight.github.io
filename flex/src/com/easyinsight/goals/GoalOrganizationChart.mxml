<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:orgchart="ilog.orgchart.*"
        creationComplete="blah()" width="100%" height="100%" xmlns:goals="com.easyinsight.goals.*" doubleClickEnabled="true">
    <mx:Metadata>
        [Event(name="solutionInstall", type="com.easyinsight.goals.SolutionInstallRequiredEvent")]
        [Event(name="splitTree", type="com.easyinsight.goals.SplitGoalTreeEvent")]
    </mx:Metadata>
    <mx:Script>
		<![CDATA[
        import ilog.orgchart.OrgChartEvent;
        import mx.collections.ArrayCollection;
        import mx.managers.PopUpManager;

        [Bindable]
        private var _goalTreeNodes:GoalTreeNode;

        [Bindable]
        private var itemSelected:Boolean;

        [Bindable]
        private var goalAdminRendererFactory:GoalAdminRendererFactory = new GoalAdminRendererFactory();

        [Bindable]
        [Embed(source="../../../../assets/element_down.png")]
        private var newParentIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/element_add.png")]
        private var addNodeIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/element_copy.png")]
        private var copyNodeIcon:Class;

        [Bindable]
        [Embed(source="../../../../assets/element_delete.png")]
        private var deleteNodeIcon:Class;

        public function set goalTreeNodes(nodes:GoalTreeNode):void {
            this._goalTreeNodes = nodes;
        }

        private function newTree(event:GoalContextEvent):void {
            var goalTreeNode:GoalTreeNode = event.goalTreeNode;
            var window:NewSubTreeWindow = new NewSubTreeWindow();
            window.node = goalTreeNode;
            window.addEventListener(SplitGoalTreeEvent.SPLIT_TREE, onSplitTree);
            PopUpManager.addPopUp(window, this, true);
        }

        private function onSplitTree(event:SplitGoalTreeEvent):void {
            dispatchEvent(event);
        }

        private function blah():void {
            myOrgChart.addEventListener(OrganizationChartRefreshEvent.ORG_CHART_REFRESH, orgRefresh);
            myOrgChart.addEventListener(GoalContextEvent.NEW_PARENT, newParent);
            myOrgChart.addEventListener(GoalContextEvent.NEW_TREE, newTree);
            myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function orgRefresh(event:OrganizationChartRefreshEvent):void {            
            myOrgChart.dataProvider = _goalTreeNodes;
            dispatchEvent(new GoalTreeChangedEvent());
        }

        private function newNode():void {
            var goalTreeNode:GoalTreeNode = getSelectedNode();
            var newChild:GoalTreeNode = new GoalTreeNode();
            goalTreeNode.children.addItem(newChild);
            newChild.parent = goalTreeNode;
            myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function getSelectedNode():GoalTreeNode {
            return myOrgChart.selectedItems[0];
        }

        private function newParent(event:GoalContextEvent):void {
            var node:GoalTreeNode = event.goalTreeNode;
            var newParent:GoalTreeNode = new GoalTreeNode();
            var children:ArrayCollection = new ArrayCollection();
            children.addItem(node);
            newParent.children = children;
            if (node == this._goalTreeNodes) {
                node.parent = newParent;
                _goalTreeNodes = newParent;
            } else {
                var existingParent:GoalTreeNode = node.parent;
                newParent.parent = existingParent;
                var index:int = existingParent.children.getItemIndex(node);
                existingParent.children.removeItemAt(index);
                existingParent.children.addItemAt(newParent, index);
                node.parent = newParent;
            }
            myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function copyNode():void {
            var goalTreeNode:GoalTreeNode = getSelectedNode();
            
        }

        private function deleteNode():void {
            var goalTreeNode:GoalTreeNode = getSelectedNode();
            var parent:GoalTreeNode = goalTreeNode.parent;
            parent.children.removeItemAt(parent.children.getItemIndex(goalTreeNode));
            if (goalTreeNode.children != null) {
                for each (var childNode:GoalTreeNode in goalTreeNode.children) {
                    childNode.parent = parent;
                    parent.children.addItem(childNode);
                }
            }
            myOrgChart.dataProvider = _goalTreeNodes;
        }

        private function onOrgClick():void {
            itemSelected = myOrgChart.selectedItems.length > 0;
        }

        /*private function onItemDoubleClick(event:OrgChartEvent):void {
            //var item:OrgChartItem = event.item as OrgChartItem;
            var node:GoalTreeNode = event.item as GoalTreeNode;
            var goalNodeWindow:GoalNodeAdminWindow = new GoalNodeAdminWindow();
            goalNodeWindow.goalTreeNode = node;
            goalNodeWindow.addEventListener(GoalEditEvent.GOAL_EDIT, goalEdited);
            PopUpManager.addPopUp(goalNodeWindow, this, true);
            goalNodeWindow.x = 20;
            goalNodeWindow.y = 20;
        }*/

        private function goalEdited(event:GoalEditEvent):void {
            dispatchEvent(new GoalTreeChangedEvent());
        }
		]]>
    </mx:Script>
    <mx:HBox width="100%" backgroundColor="#BDC5E2" paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
        <mx:Label text="Right click on the goals in the tree below to manipulate the tree structure. Double click on a goal to edit its properties."/>
        <!--<mx:Button icon="{addNodeIcon}" click="newNode()" toolTip="New Child" enabled="{itemSelected}"/>
        <mx:Button icon="{newParentIcon}" click="newParent()" toolTip="New Parent" enabled="{itemSelected}"/>
        <mx:Button icon="{copyNodeIcon}" click="copyNode()" toolTip="Copy Goal" enabled="{itemSelected}"/>
        <mx:Button icon="{deleteNodeIcon}" click="deleteNode()" toolTip="Delete Goal" enabled="{itemSelected}"/>-->
    </mx:HBox>
    <mx:Canvas height="100%" width="100%">
        <orgchart:OrgChart id="myOrgChart"
                       width="100%" height="100%" minZoomLevel="1" maxZoomLevel="1" allowSelection="true" allowMultipleSelection="false"
                       allowNavigation="true" layoutXPadding="50" itemClick="onOrgClick()">
            <orgchart:itemRenderer>
                <mx:Component>
                    <goals:GoalAdminRenderer2/>
                </mx:Component>
            </orgchart:itemRenderer>
        </orgchart:OrgChart>
    </mx:Canvas>
</mx:VBox>
